# 餅乾庫存算料系統 (Cookies Inventory Management System)

## 專案簡介

這是一個自動化庫存算料系統，專為餅乾禮盒生產工廠設計。系統能夠：
- 從 ERP 系統同步餅乾庫存資料到 Google Sheets
- 計算並更新生產排程的生產片數
- 根據期初庫存、生產排程和組裝排程，計算未來14天每一天每種餅乾的庫存數量
- 檢測負庫存（餅乾不足）的情況並產生警示
- 輸出詳細的庫存預估明細和負庫存警示

## 系統架構

本系統使用 **Google Sheets** 作為資料來源和結果輸出的介面，透過 Python 進行資料處理和庫存計算。

## 快速開始

### 1. 建立虛擬環境 (Python 3.12)

本專案目前使用 Python 3.12。使用 `uv` 建立虛擬環境：

```bash
uv venv --python 3.12 --seed --link-mode=symlink --clear .venv
```

### 2. 啟動虛擬環境

**Windows (Git Bash):**
```bash
source .venv/Scripts/activate
```

**Linux/macOS:**
```bash
source .venv/bin/activate
```

### 3. 安裝依賴套件

```bash
uv pip install -e .
```

如果需要安裝 ERP 資料庫連接套件（MS-SQL Server）：

```bash
uv pip install pyodbc
```

### 4. 設定 Google Sheets

確保 `config.ini` 中的 Google Sheet URL 正確，並且 `service_account.json` 中的服務帳戶有適當的權限。

### 5. 設定 ERP 資料庫連接

在 `config.ini` 中設定 ERP 資料庫連接資訊：

```ini
[ERP_DATABASE]
server = 192.168.98.10
database = AS_online
username = sa
password = dsc@23225889
```

### 6. 初始化工作表結構

```bash
python setup_sheets.py
```

這會建立系統所需的所有工作表。

### 7. 填入基礎資料

請參考下方「工作表說明」章節，在各工作表中填入：
- **Index**（代號對應表）⭐ 必須優先建立
- BOM（禮盒組成表）
- 庫存狀態
- 生產排程
- 組裝計劃

## 系統執行流程

### 步驟 1：同步 ERP 庫存資料（可選）

從 ERP 系統同步餅乾庫存到 Google Sheets：

```bash
python sync_inventory_from_erp.py
```

**功能說明：**
- 只同步 Index 工作表中存在的餅乾代號
- 合併期初庫存（INVLC）和每日進出數量（INVLA）計算即時庫存
- 支援多庫別（SP40, SP50, SP60, SP80），會按餅乾代號合併加總
- 自動更新或新增庫存資料到「庫存狀態」工作表

**注意事項：**
- 請確保 `config.ini` 中的 ERP 資料庫連接設定正確
- 禮盒成品庫存不從 ERP 同步，請手動更新「成品庫存」工作表

### 步驟 2：計算並更新生產排程的生產片數

從「生產顆數」計算「生產片數」並更新到 Google Sheets：

```bash
python sync_production_schedule.py
```

**功能說明：**
- 讀取「生產排程」工作表的所有資料
- 從 Index 工作表讀取生重資料
- 從 ERP 查詢餅乾品名（INVMB.MB002）
- 計算公式：生產片數 = 生產顆數 × 160000 / 生重 × 0.95（考慮5%損耗）
- 更新名稱欄位和生產片數欄位
- 按照標準順序重新排列欄位並更新回 Google Sheets

**注意事項：**
- 需要確保 Index 工作表有生重資料
- 需要確保生產排程工作表有必要的欄位：日期、產線代號、餅乾代號、生產顆數、生產片數

### 步驟 3：手動調整庫存狀態（如需要）

在 Google Sheets 中手動調整「庫存狀態」工作表的資料（如果需要的話）。

### 步驟 4：執行庫存算料計算

計算未來14天的庫存預估：

```bash
python calculate_cookie_inventory.py
```

**功能說明：**
- 從 Google Sheets 讀取今天的期初庫存（從「庫存狀態」工作表）
- 讀取 BOM 表、生產排程、組裝排程
- 計算未來14天每一天每種餅乾的庫存數量
- 檢測負庫存（餅乾不足）的情況
- 輸出結果到「庫存預估明細」和「負庫存警示」工作表

## 工作表說明

### 輸入資料工作表（由使用者填入）

#### 0. Index（代號對應表）⭐ 請優先填入

**用途**：存放所有代號與名稱的對應關係，是所有工作表的基礎資料

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 類型 | 項目類型 | 餅乾 / 禮盒 / 產線 |
| 代號 | 唯一識別碼 | COOKIE001 / BOX001 / LINE_A |
| 名稱 | 項目名稱 | 奶油餅乾 / 經典禮盒 / 產線A |
| 生重 | 餅乾生重（僅餅乾類型需要） | 150 |
| 熟重 | 餅乾熟重（僅餅乾類型需要） | 140 |
| 備註 | 其他說明 | - |

**注意事項：**
- 此工作表必須最先建立和維護
- 類型欄位建議使用：`餅乾`、`禮盒`、`產線`
- 代號必須唯一，不可重複
- 餅乾類型必須填入「生重」欄位（用於計算生產片數）

#### 1. BOM（禮盒組成表）

**用途**：定義每一款禮盒的餅乾組成

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 禮盒代號 | 禮盒的唯一識別碼 | BOX001 |
| 餅乾代號 | 餅乾的唯一識別碼 | COOKIE001 |
| 每盒片數 | 每個禮盒需要此餅乾的片數 | 8 |
| 備註 | 其他說明 | - |

**注意**：
- 同一款禮盒會有多筆記錄，每一筆代表一種餅乾
- 禮盒名稱和餅乾名稱請參考 Index 工作表

#### 2. 庫存狀態

**用途**：目前餅乾的庫存狀況

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 餅乾代號 | 餅乾的唯一識別碼 | COOKIE001 |
| 餅乾品名 | 餅乾名稱（可選，系統會自動填入） | 奶油餅乾 |
| 目前庫存數量 | 目前的庫存數量（片） | 5000 |
| 庫別代號 | 庫別代號（SP40, SP50, SP60, SP80） | SP40 |
| 單位 | 單位 | 片 |
| 最後更新日期 | 最後更新日期 | 2024/01/10 |

**注意**：
- 餅乾名稱請參考 Index 工作表
- 多庫別會按餅乾代號合併加總
- 支援千分位逗號格式（例如：1,000）

#### 3. 生產排程

**用途**：餅乾生產排程計畫

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 日期 | 投料日期 | 2025/1/5 |
| 產線代號 | 產線代號 | LINE_A |
| 餅乾代號 | 餅乾代號 | COOKIE001 |
| 名稱 | 餅乾名稱（系統會自動填入） | 奶油餅乾 |
| 生產顆數 | 生產顆數 | 10000 |
| 生產片數 | 生產片數（系統會自動計算） | 9500 |
| 預計完成日期 | 預計完成日期 | 2025/1/7 |
| 狀態 | 狀態 | 進行中 |
| 備註 | 其他說明 | - |

**注意**：
- 日期格式：YYYY/M/D 或 YYYY/MM/DD
- 生產片數會由 `sync_production_schedule.py` 自動計算
- 生產片數支援千分位逗號格式
- 餅乾名稱和產線名稱請參考 Index 工作表

#### 4. 組裝計劃

**用途**：後段組裝作業的排程計畫

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 日期 | 組裝日期 | 2025/1/15 |
| 禮盒代號 | 禮盒的唯一識別碼 | BOX001 |
| 計畫組裝數量 | 計畫組裝的禮盒數量 | 500 |
| 已完成數量 | 目前已完成的數量（可選） | 0 |
| 狀態 | 組裝狀態（可選） | 待開始 |
| 備註 | 其他說明 | - |

**注意**：
- 日期格式：YYYY/M/D 或 YYYY/MM/DD
- 計畫組裝數量支援千分位逗號格式
- 禮盒名稱請參考 Index 工作表

### 系統輸出工作表（由系統計算並寫入）

#### 5. 庫存預估明細

**用途**：未來14天每一天每種餅乾的庫存預估明細

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 日期 | 日期 | 2025/1/15 |
| 餅乾代號 | 餅乾代號 | COOKIE001 |
| 餅乾品名 | 餅乾名稱 | 奶油餅乾 |
| 期初庫存 | 當天早上的期初庫存 | 5000 |
| 當天組裝需求 | 當天組裝所需的餅乾數量 | 4000 |
| 預估入庫數量 | 當天預計完工入庫的數量 | 3000 |
| 期末庫存 | 當天結束時的庫存 | 4000 |
| 是否負庫存 | 是否出現負庫存 | 否 |
| 缺口數量 | 負庫存時的缺口數量 | 0 |

#### 6. 負庫存警示

**用途**：負庫存（餅乾不足）的警示清單

| 欄位名稱 | 說明 | 範例 |
|---------|------|------|
| 日期 | 日期 | 2025/1/16 |
| 餅乾代號 | 餅乾代號 | COOKIE001 |
| 餅乾品名 | 餅乾名稱 | 奶油餅乾 |
| 缺口數量 | 缺口數量 | 1000 |
| 當天組裝需求 | 當天組裝所需的餅乾數量 | 5000 |
| 期初庫存 | 當天早上的期初庫存 | 4000 |
| 預估入庫數量 | 當天預計完工入庫的數量 | 0 |

## 核心計算邏輯

### 前置天數

- **固定值**：2天
- **說明**：餅乾從投料到生產完工的前置天數
- **計算規則**：投料日期 + 2天 = 完工入庫日期

### 時間點定義

- **期初庫存**：每天早上的可用庫存數量
- **完工入庫**：完工日的早上入庫（第N天投料 → 第N+2天早上入庫，第N+2天期初可用）
- **組裝需求**：組裝日早上開始組裝時扣除庫存
- **今天的投料**：包含在計算中（因為是動態算料系統）

### 每日庫存計算公式

對每一天、每一種餅乾：

```
期初庫存 = 前一天的期末庫存（第一天使用從「庫存狀態」工作表讀取的期初庫存）
當天預計完工入庫數量 = 2天前投料的生產數量（如果有的話）
當天組裝需求量 = SUM(所有禮盒的組裝數量 × BOM中對應的每盒片數)

期末庫存 = 期初庫存 + 當天預計完工入庫數量 - 當天組裝需求量
```

### 負庫存檢測

- 如果 `期末庫存 < 0`，表示該餅乾在當天會出現不足的情況
- 系統會自動標示：日期、餅乾代號、缺口數量

### 生產排程讀取規則

1. **讀取範圍**：只讀取投料日期 >= (今天 - 3天) 的生產排程記錄  
   - 生產前置天數固定為 2 天（投料日期 + 2 天 = 完工入庫日期）
2. **預計完成日期欄位邏輯**：  
   - 若工作表的「預計完成日期」有值，則直接使用該日期  
   - 若欄位為空，系統自動使用「投料日期 + 2 天」作為預設完工日期

**範例（今天 1/5）：**
- **1/2 投料** → 1/4 完工入庫（已完工，可能今天可用）
- **1/3 投料** → 1/5 完工入庫（今天可用）
- **1/4 投料** → 1/6 完工入庫（明天可用）
- **1/5 投料** → 1/7 完工入庫（後天可用）
- **1/6 投料** → 1/8 完工入庫（大後天可用）
- ...以此類推

這些完工入庫的數量會分別加入到對應日期的期初庫存中，確保庫存計算的準確性。

**注意事項：**
- 系統只讀取「日期」、「餅乾代號」、「生產片數」三個欄位
- 「生產片數」欄位應該已經由 `sync_production_schedule.py` 計算完成
- 投料日期 < (今天 - 2天) 的記錄會被自動排除（因為已經過期）

## 資料格式注意事項

- **日期格式**：支援 `YYYY/M/D` 或 `YYYY/MM/DD` 格式（例如：2025/1/5 或 2025/01/05）
- **數字格式**：支援千分位逗號格式（例如：1,000 或 1,234.56）
- **代號格式**：建議使用統一格式，例如 `BOX001`、`COOKIE001`、`LINE_A`
- **單位**：請保持一致，例如都使用「片」或「盒」
- **名稱查詢**：所有名稱都在 Index 工作表中，其他工作表只使用代號

## 檔案說明

- `config.ini` - 系統設定檔（包含 Google Sheet URL 和 ERP 資料庫連接資訊）
- `service_account.json` - Google Service Account 憑證（請妥善保管）
- `google_sheets_helper.py` - Google Sheets 操作工具模組
- `erp_db_helper.py` - ERP 資料庫操作工具模組
- `calculate_cookie_inventory.py` - 庫存算料計算主程式
- `sync_inventory_from_erp.py` - ERP 庫存同步程式
- `sync_production_schedule.py` - 生產排程生產片數計算程式
- `setup_sheets.py` - 工作表結構初始化腳本

## 自動化排程

您可以設定定時任務（例如 Windows 工作排程器或 Linux cron）來定期執行同步和計算：

**Windows 工作排程器範例：**
- 每小時執行一次 ERP 同步：`python E:\Git\Cookies_Inventory\sync_inventory_from_erp.py`
- 每天執行一次生產片數計算：`python E:\Git\Cookies_Inventory\sync_production_schedule.py`
- 每天執行一次庫存算料：`python E:\Git\Cookies_Inventory\calculate_cookie_inventory.py`

**Linux cron 範例：**
```bash
# 每小時執行一次 ERP 同步
0 * * * * cd /path/to/Cookies_Inventory && python sync_inventory_from_erp.py

# 每天執行一次生產片數計算
0 8 * * * cd /path/to/Cookies_Inventory && python sync_production_schedule.py

# 每天執行一次庫存算料
0 9 * * * cd /path/to/Cookies_Inventory && python calculate_cookie_inventory.py
```

## 疑難排解

### 問題：無法連接資料庫

**解決方案：**
1. 檢查 `config.ini` 中的連接資訊是否正確
2. 確認資料庫伺服器是否可訪問
3. 檢查防火牆設定
4. 確認已安裝 pyodbc 套件

### 問題：無法連接 Google Sheets

**解決方案：**
1. 檢查 Google Sheets 的服務帳戶權限
2. 確認 `service_account.json` 檔案是否存在且有效
3. 確認 `config.ini` 中的 Google Sheet URL 是否正確

### 問題：某些餅乾代號沒有同步

**解決方案：**
1. 確認該餅乾代號是否在 Index 工作表中
2. 只有 Index 工作表中存在的餅乾代號才會被同步

### 問題：生產片數計算錯誤

**解決方案：**
1. 確認 Index 工作表中該餅乾代號是否有「生重」資料
2. 確認生產排程工作表中的「生產顆數」欄位是否有值
3. 執行 `sync_production_schedule.py` 重新計算

### 問題：庫存算料結果不正確

**解決方案：**
1. 確認「庫存狀態」工作表的資料是否正確
2. 確認「生產排程」工作表的「生產片數」是否已計算（執行 `sync_production_schedule.py`）
3. 確認「組裝計劃」工作表的資料是否正確
4. 確認 BOM 表的資料是否完整

## 安全注意事項

1. **保護資料庫密碼**：`config.ini` 包含敏感資訊，請不要提交到公開的版本控制系統
2. **保護服務帳戶憑證**：`service_account.json` 包含敏感資訊，請妥善保管
3. **使用最小權限原則**：建議建立一個只有讀取權限的資料庫帳號
4. **網路安全**：如果資料庫在遠端，建議使用 VPN 或加密連接

## 技術說明

- **連接方式**：使用 Google Service Account 認證
- **資料庫**：MS-SQL Server（使用 pyodbc）
- **更新頻率**：建議每天執行一次庫存算料計算
- **資料備份**：建議定期備份 Google Sheets 資料
- **資料結構**：採用正規化設計，代號與名稱分離，減少資料冗餘

## 版本資訊

- **前置天數**：2天
- **計算天數**：14天
- **生產片數計算公式**：生產顆數 × 160000 / 生重 × 0.95（考慮5%損耗）
- **日期格式**：YYYY/M/D 或 YYYY/MM/DD
- **數字格式**：支援千分位逗號格式
