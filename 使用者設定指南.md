# 餅乾庫存算料系統 - 使用者設定指南

## 首次使用設定

### 步驟 1：準備必要檔案

確保以下三個檔案都在同一個目錄下：
- `餅乾庫存算料系統.exe` - 主程式
- `config.ini` - 資料庫連線設定檔
- `service_account.json` - Google 服務帳戶憑證

### 步驟 2：設定 config.ini

1. 使用文字編輯器開啟 `config.ini`

2. 修改 `[GOOGLE_SHEETS]` 區段：
   ```ini
   [GOOGLE_SHEETS]
   data_sheet_url = https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID
   ```
   將 `YOUR_SHEET_ID` 替換為您的 Google Sheets ID

3. 修改 `[ERP_DATABASE]` 區段：
   ```ini
   [ERP_DATABASE]
   server = 192.168.98.10          # ERP 資料庫伺服器 IP
   database = AS_online             # 資料庫名稱
   username = sa                    # 資料庫使用者名稱
   password = your_password         # 資料庫密碼
   ```
   填入您的 ERP 資料庫連線資訊

4. 檢查 `[ERP_QUERIES]` 區段：
   - 確認 SQL 查詢語句符合您的資料庫結構
   - 確認日期範圍（例如：`'20251201'`、`'202512'`）是否正確

### 步驟 3：設定 service_account.json

1. 從 Google Cloud Console 取得服務帳戶憑證：
   - 登入 [Google Cloud Console](https://console.cloud.google.com/)
   - 選擇或建立專案
   - 前往「IAM 與管理」→「服務帳戶」
   - 建立新的服務帳戶或使用現有的
   - 建立金鑰（JSON 格式）
   - 下載 JSON 檔案

2. 將下載的 JSON 檔案重新命名為 `service_account.json`

3. 確保 JSON 檔案包含以下欄位：
   - `type`: "service_account"
   - `project_id`: 您的專案 ID
   - `private_key_id`: 私鑰 ID
   - `private_key`: 完整的私鑰（包含 BEGIN/END 標記）
   - `client_email`: 服務帳戶電子郵件
   - `client_id`: 客戶端 ID
   - 其他必要的 URI 欄位

### 步驟 4：設定 Google Sheets 權限

1. 開啟您的 Google Sheets
2. 點擊右上角的「共用」按鈕
3. 在「新增使用者和群組」欄位中，輸入 `service_account.json` 中的 `client_email`
4. 選擇「編輯者」權限
5. 點擊「傳送」（不需要勾選「通知人員」）

### 步驟 5：確認 ODBC 驅動程式

確保電腦已安裝 SQL Server ODBC 驅動程式：

1. 開啟「控制台」→「系統管理工具」→「ODBC 資料來源管理員」
2. 切換到「驅動程式」標籤
3. 確認是否有以下任一驅動程式：
   - ODBC Driver 17 for SQL Server
   - ODBC Driver 18 for SQL Server
   - ODBC Driver 13 for SQL Server
   - SQL Server Native Client 11.0

如果沒有，請從 [Microsoft 官網](https://docs.microsoft.com/zh-tw/sql/connect/odbc/download-odbc-driver-for-sql-server) 下載安裝

## 檔案結構範例

正確的檔案結構應該如下：

```
餅乾庫存算料系統/
├── 餅乾庫存算料系統.exe
├── config.ini
└── service_account.json
```

## 測試連線

設定完成後，執行以下測試：

1. **測試資料庫連線**：
   - 開啟 `config.ini`
   - 確認伺服器 IP、資料庫名稱、帳號密碼正確
   - 可以嘗試用其他工具（如 SQL Server Management Studio）連線測試

2. **測試 Google Sheets 連線**：
   - 確認 `service_account.json` 格式正確（有效的 JSON）
   - 確認服務帳戶已獲得 Google Sheets 的存取權限
   - 確認 Google Sheets URL 正確

3. **執行程式**：
   - 雙擊 `餅乾庫存算料系統.exe`
   - 查看日誌區域是否有錯誤訊息
   - 如果出現連線錯誤，請檢查上述設定

## 常見問題

### Q: 出現「找不到 config.ini」錯誤
**A:** 確認 `config.ini` 檔案與 exe 檔案在同一個目錄下

### Q: 出現「找不到 service_account.json」錯誤
**A:** 確認 `service_account.json` 檔案與 exe 檔案在同一個目錄下

### Q: 無法連接到資料庫
**A:** 檢查：
- `config.ini` 中的連線資訊是否正確
- 網路是否可以連接到資料庫伺服器
- 是否已安裝 SQL Server ODBC 驅動程式
- 防火牆是否允許連線

### Q: 無法連接到 Google Sheets
**A:** 檢查：
- `service_account.json` 格式是否正確
- 服務帳戶是否已獲得 Google Sheets 的存取權限
- Google Sheets URL 是否正確

### Q: 出現「權限不足」錯誤
**A:** 確認服務帳戶在 Google Sheets 中的權限至少為「編輯者」

## 安全注意事項

⚠️ **重要：這些檔案包含機密資訊，請妥善保管！**

1. **不要**將 `config.ini` 和 `service_account.json` 分享給未授權的人員
2. **不要**將這些檔案上傳到公開的版本控制系統（如 GitHub）
3. 如果憑證洩露，請立即：
   - 在 Google Cloud Console 中刪除該服務帳戶金鑰
   - 建立新的服務帳戶金鑰
   - 更新 `service_account.json`
4. 定期更換資料庫密碼和服務帳戶金鑰
