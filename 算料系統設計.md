# 餅乾庫存算料系統 - 系統設計文件

## 一、系統目標

建立一個簡化的算料系統，用於核對未來14天每一天餅乾的庫存數量，檢測是否會出現負庫存（餅乾不足）的情形。

## 二、輸入資料

### 2.1 期初庫存（從ERP系統同步）
- **資料來源**：`sync_inventory_from_erp.py` + `sync_wip_from_erp.py`
- **工作表**：`庫存狀態` + `在製品庫存`
- **說明**：
  - 昨天生產結束後的餅乾期末庫存（包含在製品）
  - 已由系統合併加總，不會重複計入
  - 作為今天早上的期初庫存

### 2.2 BOM表（禮盒組成表）
- **資料來源**：Google Sheets `BOM` 工作表
- **欄位**：禮盒代號、餅乾代號、每盒片數
- **說明**：用於將禮盒組裝數量展開為餅乾需求量

### 2.3 餅乾生產排程
- **資料來源**：Google Sheets `生產排程建議` 工作表
- **欄位**：日期、產線代號、餅乾代號、建議生產數量_片、預計開始時間、預計完成時間、狀態、備註
- **說明**：
  - 未來14天每一天的餅乾生產排程
  - **重要**：排除今天的投料記錄（因為今天的投料已經進入系統，會顯示在「在製品庫存」中）
  - 生產日期 + 5天 = 預計完工入庫日期

### 2.4 禮盒組裝排程
- **資料來源**：Google Sheets `組裝計劃` 工作表
- **欄位**：日期、禮盒代號、計畫組裝數量、已完成數量、狀態、備註
- **說明**：未來14天每一天的禮盒組裝排程

## 三、核心計算邏輯

### 3.1 前置天數
- **固定值**：5天
- **說明**：餅乾從投料到生產完工的前置天數
- **計算規則**：投料日期 + 5天 = 完工入庫日期（假設在完工日的早上入庫，第N+5天期初可用）

### 3.2 時間點定義
- **期初庫存**：每天早上的可用庫存數量
- **完工入庫**：完工日的早上入庫（第N天投料 → 第N+5天早上入庫，第N+5天期初可用）
- **組裝需求**：組裝日早上開始組裝時扣除庫存
- **今天的投料**：不計入生產排程（因為已包含在「在製品庫存」中）

### 3.3 每日庫存計算公式

對每一天、每一種餅乾：

```
期初庫存 = 前一天的期末庫存
當天預計完工入庫數量 = 5天前投料的生產數量（如果有的話）
當天組裝需求量 = SUM(所有禮盒的組裝數量 × BOM中對應的每盒片數)

期末庫存 = 期初庫存 + 當天預計完工入庫數量 - 當天組裝需求量
```

### 3.4 負庫存檢測
- 如果 `期末庫存 < 0`，表示該餅乾在當天會出現不足的情況
- 系統需要標示：日期、餅乾代號、缺口數量

## 四、輸出資料

### 4.1 庫存預估明細表
建議工作表名稱：`庫存預估明細` 或 `庫存算料結果`

**欄位結構**：
| 日期 | 餅乾代號 | 期初庫存 | 預計完工入庫 | 組裝需求量 | 期末庫存 | 是否負庫存 | 缺口數量 |
|------|---------|---------|------------|-----------|---------|-----------|---------|
| 2024/01/15 | COOKIE001 | 5000 | 3000 | 4000 | 4000 | 否 | 0 |
| 2024/01/16 | COOKIE001 | 4000 | 0 | 5000 | -1000 | 是 | 1000 |

### 4.2 負庫存警示表
建議工作表名稱：`負庫存警示` 或 `庫存不足警示`

**欄位結構**：
| 日期 | 餅乾代號 | 缺口數量 | 當天組裝需求量 | 期初庫存 | 預計完工入庫 |
|------|---------|---------|--------------|---------|------------|
| 2024/01/16 | COOKIE001 | 1000 | 5000 | 4000 | 0 |
| 2024/01/17 | COOKIE002 | 500 | 3000 | 2000 | 500 |

## 五、系統流程

1. **讀取期初庫存**
   - 從 `庫存狀態` 工作表讀取目前庫存（已合併在製品）
   - 按餅乾代號加總（如果有多庫別，需要合併）

2. **讀取BOM表**
   - 從 `BOM` 工作表讀取禮盒組成資料
   - 建立字典：{禮盒代號: {餅乾代號: 每盒片數, ...}}

3. **讀取生產排程**
   - 從 `生產排程建議` 工作表讀取未來14天的投料計畫
   - **排除今天的投料記錄**（因為今天的投料已經包含在「在製品庫存」中）
   - 建立字典：{投料日期: {餅乾代號: 生產數量, ...}}
   - 計算完工入庫日期 = 投料日期 + 5天
   - 建立字典：{完工入庫日期: {餅乾代號: 生產數量, ...}}

4. **讀取組裝排程**
   - 從 `組裝計劃` 工作表讀取未來14天的組裝計畫
   - 使用BOM表展開為餅乾需求量
   - 計算公式：餅乾需求量 = SUM(禮盒組裝數量 × BOM中對應的每盒片數)
   - 建立字典：{組裝日期: {餅乾代號: 需求量, ...}}

5. **計算每日庫存**
   - 從今天開始，逐日計算未來14天的庫存
   - 對每一種餅乾：
     - 期初庫存 = 前一天的期末庫存
     - 完工入庫 = 5天前投料的數量（如果有的話）
     - 組裝需求 = 當天所有禮盒的餅乾需求量
     - 期末庫存 = 期初 + 完工入庫 - 組裝需求

6. **檢測負庫存**
   - 標記所有期末庫存 < 0 的記錄

7. **輸出結果**
   - 寫入 `庫存預估明細` 工作表
   - 寫入 `負庫存警示` 工作表

## 六、已確認事項

### 6.1 資料來源
- ✅ BOM表：`BOM` 工作表
- ✅ 組裝排程：`組裝計劃` 工作表
- ✅ 生產排程：`生產排程建議` 工作表
- ✅ 期初庫存：`庫存狀態` + `在製品庫存` 工作表（已合併，不重複）

### 6.2 計算邏輯
- ✅ 前置天數：固定5天
- ✅ 完工入庫：投料日期 + 5天（早上入庫）
- ✅ 今天的投料：不計入生產排程（已包含在在製品庫存中）

### 6.3 庫別處理
- **待確認**：`庫存狀態` 工作表有多庫別（SP40, SP50, SP60），是否需要：
  - 選項A：合併所有庫別的庫存（建議）
  - 選項B：分別計算各庫別的庫存

### 6.4 輸出格式
- **待確認**：是否需要在 Google Sheets 中建立輸出工作表？
  - 建議建立：`庫存預估明細` 和 `負庫存警示` 工作表

---

**可以開始進行程式碼撰寫。**
