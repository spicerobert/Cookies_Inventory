# 餅乾庫存算料系統 - 打包說明

## 前置需求

1. **安裝 Python 3.12 或以上版本**

2. **建立並啟動虛擬環境（使用 UV）**

   本專案使用 UV 和 pyproject.toml 管理依賴套件。建議使用 UV 建立虛擬環境：
   
   **建立虛擬環境：**
   ```bash
   uv venv --python 3.12 --seed --link-mode=symlink --clear .venv
   ```
   
   **啟動虛擬環境：**
   
   **Windows (Git Bash / CMD):**
   ```bash
   source .venv/Scripts/activate
   ```
   
   **Windows (PowerShell):**
   ```powershell
   .venv\Scripts\Activate.ps1
   ```
   
   **Linux/macOS:**
   ```bash
   source .venv/bin/activate
   ```
   
   **安裝專案依賴套件：**
   ```bash
   uv pip install -e .
   ```
   
   這會自動從 `pyproject.toml` 安裝所有必要的套件，包括：
   - `gspread>=5.12.0`
   - `google-auth>=2.23.0`
   - `google-auth-oauthlib>=1.1.0`
   - `google-auth-httplib2>=0.1.1`
   - `pyodbc>=5.3.0`
   - 以及其他所有依賴
   
   **安裝 PyInstaller（用於打包）：**
   ```bash
   uv pip install pyinstaller
   ```
   
   **替代方式：不使用虛擬環境（直接使用 UV）**
   
   如果不想手動啟動虛擬環境，也可以直接使用 `uv run` 命令：
   ```bash
   uv run pyinstaller build_exe.spec
   ```
   
   這會自動在 UV 管理的虛擬環境中執行命令。

## GUI 圖形界面功能

打包後的 `餅乾庫存算料系統.exe` 提供以下功能：

1. **同步 Index 資料** - 從 ERP 同步餅乾、禮盒等基本資料到 Google Sheets
2. **同步在製品庫存** - 從 ERP 同步在製品庫存資料
3. **同步生產排程** - 從 ERP 同步生產排程並計算生產片數
4. **同步完工入庫** - 從 ERP 同步完工入庫資料到 Google Sheets
5. **計算庫存預估** - 計算未來 21 天的庫存預估和負庫存警示

所有功能都透過圖形界面操作，執行過程會顯示在日誌視窗中。

## 打包步驟

### 方法一：使用 spec 檔案（推薦）

1. 確保所有必要檔案都在專案目錄中：
   - `cookie_inventory_gui.py` - 主程式（GUI 圖形界面）
   - `config.ini` - 設定檔
   - `service_account.json` - Google 服務帳戶憑證
   - `sync_index_from_erp.py` - 同步 Index 資料模組
   - `sync_inventory_from_erp.py` - 同步庫存資料模組
   - `sync_wip_from_erp.py` - 同步在製品庫存模組
   - `sync_production_schedule.py` - 同步生產排程模組
   - `sync_receipt_from_erp.py` - 同步完工入庫模組
   - `calculate_cookie_inventory.py` - 計算庫存預估模組
   - `google_sheets_helper.py` - Google Sheets 操作輔助模組
   - `erp_db_helper.py` - ERP 資料庫連接輔助模組

2. **確認已啟動虛擬環境**（如果使用手動啟動方式）

   如果使用 `source .venv/Scripts/activate` 啟動虛擬環境，請確認命令提示字元前面有 `(.venv)` 標記。

3. 執行打包命令：
   ```bash
   pyinstaller build_exe.spec
   ```
   
   或使用 UV 直接執行（不需要手動啟動虛擬環境）：
   ```bash
   uv run pyinstaller build_exe.spec
   ```

4. 打包完成後，可執行檔案會在 `dist/` 目錄中

### 方法二：使用命令列參數

```bash
pyinstaller --noconsole --onefile --name "餅乾庫存算料系統" ^
    --hidden-import gspread ^
    --hidden-import google.oauth2.service_account ^
    --hidden-import google.auth ^
    --hidden-import pyodbc ^
    --hidden-import tkinter ^
    --hidden-import tkinter.ttk ^
    --hidden-import threading ^
    --hidden-import sync_index_from_erp ^
    --hidden-import sync_inventory_from_erp ^
    --hidden-import sync_wip_from_erp ^
    --hidden-import sync_production_schedule ^
    --hidden-import sync_receipt_from_erp ^
    --hidden-import calculate_cookie_inventory ^
    --hidden-import google_sheets_helper ^
    --hidden-import erp_db_helper ^
    cookie_inventory_gui.py
```

**注意：** `config.ini` 和 `service_account.json` 不應使用 `--add-data` 打包，這些檔案包含機密資訊，需要使用者自行提供。

## 打包後的檔案結構

打包完成後，`dist/` 目錄中會產生：
- `餅乾庫存算料系統.exe` - 可執行檔案（GUI 圖形界面程式）

**打包的模組包含：**
- `cookie_inventory_gui.py` - GUI 主程式
- `sync_index_from_erp.py` - 同步 Index 資料
- `sync_inventory_from_erp.py` - 同步庫存資料
- `sync_wip_from_erp.py` - 同步在製品庫存
- `sync_production_schedule.py` - 同步生產排程
- `sync_receipt_from_erp.py` - 同步完工入庫
- `calculate_cookie_inventory.py` - 計算庫存預估
- `google_sheets_helper.py` - Google Sheets 操作
- `erp_db_helper.py` - ERP 資料庫連接
- 所有必要的 Python 套件和依賴

## ⚠️ 重要：機密檔案不會被打包

**基於安全考量，`config.ini` 和 `service_account.json` 這兩個包含機密資訊的檔案不會被打包進 exe。**

### 使用者需要自行提供的檔案

分發給使用者時，需要提供以下檔案：

1. **`餅乾庫存算料系統.exe`** - 主程式
2. **`config.ini`** - 資料庫連線設定檔（包含密碼等機密資訊）
3. **`service_account.json`** - Google 服務帳戶憑證（包含私鑰等機密資訊）

### 檔案放置位置

將這三個檔案放在**同一個目錄**下，例如：
```
餅乾庫存算料系統/
├── 餅乾庫存算料系統.exe
├── config.ini
└── service_account.json
```

### 範本檔案

專案中提供了範本檔案供參考：
- `config.ini.template` - 設定檔範本
- `service_account.json.template` - 憑證檔案範本

**注意：範本檔案中的 `YOUR_*` 需要替換為實際值**

## 注意事項

1. **設定檔和憑證檔案**
   - `config.ini` 和 `service_account.json` **不會**被打包進 exe
   - 使用者必須將這兩個檔案放在 exe 同目錄下
   - 程式會從 exe 同目錄讀取這些檔案

2. **ODBC 驅動程式**
   - 目標電腦需要安裝 SQL Server ODBC 驅動程式
   - 可以從 Microsoft 官網下載：
     - ODBC Driver 17 for SQL Server
     - ODBC Driver 18 for SQL Server

3. **檔案大小**
   - 打包後的 exe 檔案可能會比較大（約 50-100 MB）
   - 這是因為包含了所有 Python 依賴套件

4. **防毒軟體**
   - 某些防毒軟體可能會誤報打包後的 exe 檔案
   - 這是 PyInstaller 打包工具的常見情況，可以加入白名單

## 測試打包後的程式

1. 在沒有安裝 Python 的電腦上測試
2. **必須**確保以下檔案都在同一個目錄：
   - `餅乾庫存算料系統.exe`
   - `config.ini`（**必須提供**）
   - `service_account.json`（**必須提供**）

3. 雙擊執行 `餅乾庫存算料系統.exe`

### 首次設定步驟

如果是新使用者，需要：

1. 複製 `config.ini.template` 為 `config.ini`
2. 編輯 `config.ini`，填入：
   - Google Sheets URL
   - ERP 資料庫連線資訊（伺服器、資料庫名稱、帳號、密碼）
   - SQL 查詢語句（如果需要自訂）

3. 複製 `service_account.json.template` 為 `service_account.json`
4. 編輯 `service_account.json`，填入：
   - 從 Google Cloud Console 取得的服務帳戶憑證資訊
   - 包含完整的 private_key、client_email 等資訊

5. 確保 Google Sheets 已授予服務帳戶存取權限

## 疑難排解

### 問題：執行時出現「找不到模組」錯誤

**解決方法：**
- 檢查 `build_exe.spec` 中的 `hiddenimports` 是否包含所有必要的模組
- 確認所有 Python 模組檔案都在專案目錄中
- 重新執行打包命令
- 如果缺少特定模組，在 `hiddenimports` 中加入該模組名稱

**常見缺少的模組：**
- `sync_receipt_from_erp` - 同步完工入庫模組
- `tkinter` 或 `tkinter.ttk` - GUI 界面模組
- `threading` - 多線程模組

### 問題：無法連接到資料庫

**解決方法：**
- 確認目標電腦已安裝 SQL Server ODBC 驅動程式
- 檢查 `config.ini` 中的資料庫連線設定

### 問題：無法連接到 Google Sheets

**解決方法：**
- 確認 `service_account.json` 檔案正確
- 確認 Google Sheets 已授予服務帳戶存取權限

### 問題：程式執行緩慢

**解決方法：**
- 使用 `--onefile` 模式會較慢，因為需要解壓縮
- 可以改用目錄模式（移除 `--onefile`），但需要包含整個目錄

## 進階設定

### 自訂圖示

1. 準備一個 `.ico` 圖示檔案
2. 在 `build_exe.spec` 中修改：
   ```python
   icon='your_icon.ico',
   ```

### 減少檔案大小

可以排除不需要的模組：
```python
excludes=['matplotlib', 'numpy', 'pandas'],  # 如果不需要這些模組
```
